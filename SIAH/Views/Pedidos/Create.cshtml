@model SIAH.Models.Pedidos.Pedido


@{
    ViewBag.Title = "Generar Pedido";

    var detallesPedido = Model.detallesPedido;
}

@using (Html.BeginForm(new { enctype = "multipart/form-data" }))
{
    @Html.AntiForgeryToken()
    @Html.ValidationSummary(true, "", new { @class = "text-danger" })
    <div class="form-horizontal">
        <h2 class="title">Generar Pedido</h2>
        <hr />
        @Html.ValidationSummary(true, "", new { @class = "text-danger" })
        <div class="row">

            <br />
            <div class="col-md-7" id="det">
                <div class="card card-raised">
                    @*<div class="panel-heading">INSUMOS</div>*@

                    <div class="text-center">
                        <h3><strong>Agregue insumos</strong></h3>
                    </div>
                    <div class="form-group">
                        @*<label class="control-label col-md-3">Seleccione un tipo</label>*@
                        <div class="col-md-offset-1 col-md-10">
                            <select class="form-control" id="tipo">
                                <option value="">Seleccione un tipo de Insumo</option>
                                @{ var tipoInsumo = ViewBag.tipoInsumo;}
                                @foreach (var item in tipoInsumo)
                                {
                                    <option value="@item.Value">@item.Text</option>
                                }
                            </select>
                        </div>
                        @*<div class="col-md-7">
                                @Html.Label("Campo opcional", null, htmlAttributes: new { })
                            </div>*@
                    </div>

                    <div class="col-md-offset-1 col-md-10">
                        <div id="insu" class="form-group label-floating">
                            @Html.LabelFor(model => model.detallesPedido, "Insumo", htmlAttributes: new { @class = "control-label " })


                            <input  id="q" class="form-control style='background-color: white' buscador ui-autocomplete-input" type="text" value="" autocomplete="on" required>
                            
                        </div>

                    </div>

                    <div class="col-md-offset-1 col-md-10">
                        <div id="canti" class="form-group label-floating">
                            @Html.Label("Cantidad", null, htmlAttributes: new { @class = "control-label" })

                            @*@Html.TextBox("Cantidad", null, htmlAttributes: new { @class = "form-control", @id = "cantidad", @type = "number", @valueDefault = 0, @valueMin = 0 })*@
                            <input type="number" maxlength="7" id="cantidad" class="form-control" min="0" required onkeypress="return event.charCode >= 48 && event.charCode <= 57" />
                        </div>
                    </div>

                    <div class="col-md-offset-7 col-md-5 margen-arriba">
                        <input id="btn_addInsumo"  type="submit" value="Agregar Insumo" class="btn btn-success btn-round btn_addInsumo" />
                    </div>
                    <br>
                </div>
            </div>

            <div class="col-md-5">
                <div class="card card-raised">
                    <div class="text-center">
                        <h3><strong>Información</strong></h3>
                    </div>
                    <div class="form-group">
                        @Html.LabelFor(model => model.periodo, "Período", htmlAttributes: new { @class = "control-label col-md-5" })
                        <div class="col-md-6">
                            @Html.TextBox("periodo", DateTime.Today.ToString("MMMM - yyyy"), htmlAttributes: new { @class = "form-control", @readonly = "readonly", @value = DateTime.Today })
                            @Html.ValidationMessageFor(model => model.periodo, "", new { @class = "text-danger" })
                        </div>
                    </div>

                    <div class="form-group">
                        @Html.LabelFor(model => model.fechaGeneracion, "Fecha Generación", htmlAttributes: new { @class = "control-label col-md-5" })
                        <div class="col-md-6">
                            @Html.TextBox("fechaGeneracion", DateTime.Today.ToShortDateString(), htmlAttributes: new { @class = "form-control", @readonly = "readonly", @value = DateTime.Today })
                            @Html.ValidationMessageFor(model => model.fechaGeneracion, "", new { @class = "text-danger" })
                        </div>
                    </div>

                    <div class="form-group">
                        @Html.LabelFor(model => model.hospitalId, "Hospital", htmlAttributes: new { @class = "control-label col-md-5" })
                        <div class="col-md-6">
                            @Html.DropDownList("hospitalId", null, htmlAttributes: new { @class = "form-control" })
                            @Html.ValidationMessageFor(model => model.hospitalId, "", new { @class = "text-danger" })
                        </div>
                    </div>
                    <div class="form-group">
                        @Html.LabelFor(model => model.esUrgente, "Urgente", htmlAttributes: new { @class = "control-label col-md-5", data_toggle = "tooltip", data_placement = "top", data_original_title = "tooltip here" })
                        <div class="col-md-6">
                            <div class="checkbox">
                                <label>
                                    @Html.CheckBoxFor(model => model.esUrgente, htmlAttributes: new { @type = "checkbox", @name = "optionsCheckboxes", data_toggle = "tooltip", data_placement = "right", data_original_title = "Seleccione esta casilla si su pedido es Urgente" })
                                    @Html.ValidationMessageFor(model => model.esUrgente, "", new { @class = "text-danger" })

                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="form-group">
            <h3 class="col-md-7"><strong>Listado de Insumos</strong></h3>
            <table class="col-md-9 table  table-hover table-condensed">
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>Tipo</th>
                        <th>Cantidad</th>
                        <th>Precio Unitario</th>
                        <th>Sub Total</th>
                        <th width="40px">Acciones</th>
                    </tr>
                </thead>
                <tbody name="detallesPedido" id="detallesPedido">
                    <tr class="empty well text-center">
                        <td colspan="6">Aun no se han agregado insumos</td>
                    </tr>
                </tbody>
            </table>


            @*<div class="form-group">*@
            <div class="col-md-offset-10 col-md-2" style="width: 13%">
                <div class="panel panel-DEFAULT text-center">
                    @*<div class="panel-heading">INSUMOS</div>*@
                    <div class="panel-body">
                        @Html.Label("Total", null, htmlAttributes: new { @class = "control-label" })
                        <strong>
                            @Html.TextBox("total", 0, htmlAttributes: new { @readonly = "readonly", @class = "form-control text-center tot" })
                        </strong>
                    </div>
                </div>
            </div>
            <div class="col-md-offset-10 col-md-2">
                <input type="submit" id="enviar" value="Enviar Pedido" class="btn btn-primary" />
            </div>

        </div>
    </div>
                                    }

<div>
    @Html.ActionLink("Volver al Inicio", "Index", "Home")
</div>

@section Scripts {

    <script type="text/javascript">
        $(document).ready(function () {
            //Este método borra los campos requeridos de insumo y cantidad para
            //que se pueda submitear el form sin que los pida, ya que no son necesarios.
            $(document).on('click', '#enviar', function () {
                document.getElementById("q").removeAttribute('required');
                document.getElementById("cantidad").removeAttribute('required');
            });

                var total = 0;
                var indice = $('#detallesPedido > tr').not('.empty').length;
                $('#enviar').hide();
                var data = '';
                $("#q").autocomplete({
                    minLength: 1,
                    source: function (request, response) {
                        $.ajax({
                            url: '@Url.Action("../Insumos/BuscarInsumos")',
                            dataType: "json",
                            type: "GET",
                            contentType: "application/json; charset=utf-8",
                            data: {
                                term: request.term,
                                id: $('#tipo').val()
                            },
                            success: function (data) {
                                response(data);
                            }
                        });
                    },
                    select: function (event, p) {
                        data = p.item;
                        $('#q').val(p.item.nombre);
                        $('#idInsumo').val(p.item.id);
                        return false;
                    }
                }).autocomplete("instance")._renderItem = function (ul, item) {
                    return $("<li>")
                            .append("<div><strong>" + item.nombre + "</strong><br><em>" + item.tipo + "</em></div>")
                            .appendTo(ul);
                        }
                $(document).on('click', '.btn-eliminar-detallesPedido', function () {
                    //Funcion que calcula el subtotal de la fila y lo resta al total al eliminar un elemento
                    //Luego elimina la fila entera del detalle y verifica si la lista esta vacia para ocultar el boton enviar
                    var $aRestar = 0;
                    $aRestar = parseFloat($(this).parents('tr').get(0).children.item(2).innerHTML) * parseFloat($(this).parents('tr').get(0).children.item(3).innerHTML);
                    //console.log($aRestar);
                    total -= $aRestar;
                    console.log($(this).parents('tr'));
                   // $('#detallesPedido > tr').get($(this).parents('tr').get(0).;
                    $(this).parents('tr').remove();
                    indice--;
                    //console.log($('#detallesPedido > tr').get(i));

                    var $totalAMostrar = new Intl.NumberFormat('de-DE').format(total);

                    $('#total').val("$" + $totalAMostrar);
                        if ($('#detallesPedido > tr').not('.empty').length == 0) {
                            $('#enviar').hide();
                            $('#detallesPedido .empty').show();
                        }
                    });
                    //Boton para agregar insumo a la lista
                $(document).on('click', '.btn_addInsumo', function (event) {
                         //Previene que se submitee el Form con este botón. Solo valide los campos vacios.
                        event.preventDefault();

                        if (data != '' && $('#cantidad').val() != "") {
                            if ($('#detallesPedido .empty').is(':visible')) {
                                $('#detallesPedido .empty').hide();
                                $('#enviar').show();
                            }
                            //console.log(data);
                            var $insumo_id = $('<input>').attr('type', 'hidden').attr('name', 'detallesPedido[' + indice + '][insumo][id]').val(data.id);
                            var $insumoId = $('<input>').attr('type', 'hidden').attr('name', 'detallesPedido[' + indice + '][insumoId]').val(data.id);
                            var $nombre = $('<input>').attr('type', 'hidden').attr('name', 'detallesPedido[' + indice + '][insumo][nombre]').val(data.nombre);
                            var $tdInsumo = $('<td>').html(data.nombre).append($insumoId, $insumo_id, $nombre);

                            var $tipo = $('<input>').attr('type', 'hidden').attr('name', 'detallesPedido[' + indice + '][insumo][tiposInsumo][nombre]').val(data.tipo);
                            var $tdTipo = $('<td>').html(data.tipo).append($tipo);

                            var $precioAMostrar = new Intl.NumberFormat('de-DE').format(data.precioUnitario);

                            var $precioUnitario = $('<input>').attr('type', 'hidden').attr('name', 'detallesPedido[' + indice + '][insumo][precioUnitario]').val($precioAMostrar);
                            var $tdPrecioUnitario = $('<td>').html($precioAMostrar).append($precioUnitario);

                            var $cantidad = $('<input>').attr('type', 'hidden').attr('name', 'detallesPedido[' + indice + '][cantidad]').val($('#cantidad').val());
                            var $tdCantidad = $('<td>').html($('#cantidad').val()).append($cantidad);

                            var $subtotalCalculado = data.precioUnitario * $('#cantidad').val();
                            var $subtotalAMostrar = new Intl.NumberFormat('de-DE').format($subtotalCalculado);

                            var $subtotal = $('<input>').attr('type', 'hidden').attr('name', 'subtotal').val($subtotalAMostrar);
                            var $tdSubtotal = $('<td>').html('$' + $subtotalAMostrar).append($cantidad);

                            var $boton = $('<button>').attr('type', 'button').attr('rel', 'tooltip').attr('title', 'Eliminar Insumo').addClass('btn btn-danger btn-simple btn-xs btn-eliminar-detallesPedido').append($('<i>').addClass('fa fa-times'));
                            var $tdAccion = $('<td>').addClass('td-actions text-right').append($boton);

                            var $tr = $('<tr>').append($tdInsumo, $tdTipo, $tdCantidad, $tdPrecioUnitario, $tdSubtotal, $tdAccion);
                            $('#detallesPedido').append($tr);
                            indice++;
                            total += $subtotalCalculado;

                           
                           

                            //Vacia los text box
                            $('#q').val("");
                            $('#cantidad').val("");
                            $('#tipo').val("");

                            //Agrega un atributo a la clase, para que se reinicien los inputs
                            $('#insu').attr('class', 'form-group label-floating is-empty');
                            $('#canti').attr('class', 'form-group label-floating is-empty');

                            data = '';
                            $('#total').val("$"+total);
                        }
                    });



                });
    </script>
}